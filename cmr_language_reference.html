

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cubert Map-Reduce Language Reference &mdash; Cubert 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Cubert 0.1.0 documentation" href="index.html"/>
        <link rel="next" title="Understanding Cubert Concepts" href="concepts/index.html"/>
        <link rel="prev" title="Our First Cubert Program" href="wordcount.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Cubert</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html#upgrading-cubert">Upgrading Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wordcount.html">Our First Cubert Program</a><ul>
<li class="toctree-l2"><a class="reference internal" href="wordcount.html#the-cubert-map-reduce-cmr-script">The Cubert Map-Reduce (.cmr) Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="wordcount.html#parsing-and-compiling-the-script">Parsing and Compiling the Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="wordcount.html#running-the-script">Running the Script</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Cubert Map-Reduce Language Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#structure-of-a-cubert-program">Structure of a Cubert Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="#word-count-in-cubert">Word Count in Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="concepts/index.html">Understanding Cubert Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="concepts/blocks.html">Partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts/coblocks.html">Co-partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts/rubixtool.html">Analyzing Rubix File with <em>rubixtool</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts/grouping_sets.html">Aggregation: Cube and Grouping Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts/conditions.html">Operator Preconditions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="operators/index.html">Cubert Operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="operators/load_store.html">Input/Output Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/processing.html">Processing Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/builtin_functions.html">Builtin Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/join.html">Join Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/aggregation.html">Aggregation Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/dictionary.html">Dictionary Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/blocks.html">Block Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="operators/shuffle.html">Shuffle Operators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="userdefined/index.html">Extending Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="userdefined/functions.html">User Defined Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="userdefined/aggregations.html">User Defined Aggregation Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="userdefined/operators.html">Adding new Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="userdefined/storage.html">Adding new Storage Formats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="patterns/index.html">Typical Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="patterns/union.html">UNION Pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="javadoc.html">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="publications.html">Publications and Presentations</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Cubert</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Cubert Map-Reduce Language Reference</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="cubert-map-reduce-language-reference">
<span id="script-reference"></span><h1>Cubert Map-Reduce Language Reference<a class="headerlink" href="#cubert-map-reduce-language-reference" title="Permalink to this headline">¶</a></h1>
<div class="section" id="structure-of-a-cubert-program">
<h2>Structure of a Cubert Program<a class="headerlink" href="#structure-of-a-cubert-program" title="Permalink to this headline">¶</a></h2>
<p>A program written in Cubert Script has a header section (optional) followed by the job definition section:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">&lt;&lt;</span> <span class="n">header</span> <span class="n">section</span> <span class="o">(</span><span class="n">optional</span><span class="o">)</span> <span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span> <span class="n">job</span> <span class="n">definition</span> <span class="n">section</span> <span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Cubert Script uses Java-style comments (// and /* .. */).</p>
</div>
<div class="section" id="structure-of-the-header-section">
<h3>Structure of the Header Section<a class="headerlink" href="#structure-of-the-header-section" title="Permalink to this headline">¶</a></h3>
<p>The header section consists of three kinds of commands:</p>
<ul class="simple">
<li>REGISTER command: to add custom jars to distributed cache and add them to classpath of mappers and reducers.</li>
<li>SET command: to assign hadoop specific configuration parameters.</li>
<li>FUNCTION command: to provide constructor arguments to UDFs and/or provide alias names to UDFs.</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span class="n">REGISTER</span> <span class="s">&quot;myUDFJar.jar&quot;</span><span class="p">;</span>
<span class="n">REGISTER</span> <span class="s">&quot;/usr/lib/somejar.jar&quot;</span><span class="p">;</span>

<span class="c1">// note that the &#39;values&#39; are written as Strings</span>
<span class="n">SET</span> <span class="n">mapred</span><span class="p">.</span><span class="n">child</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">opts</span>  <span class="s">&quot;-Xmx1G -Djava.net.preferIPv4Stack=true -Duser.timezone=America/Los_Angeles&quot;</span><span class="p">;</span>
<span class="n">SET</span> <span class="n">mapred</span><span class="p">.</span><span class="n">map</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">speculative</span><span class="p">.</span><span class="n">execution</span> <span class="s">&quot;true&quot;</span><span class="p">;</span>
<span class="n">SET</span> <span class="n">mapred</span><span class="p">.</span><span class="n">reduce</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">speculative</span><span class="p">.</span><span class="n">execution</span> <span class="s">&quot;true&quot;</span><span class="p">;</span>
<span class="n">SET</span> <span class="n">mapred</span><span class="p">.</span><span class="n">job</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">name</span> <span class="s">&quot;marathon&quot;</span><span class="p">;</span>

<span class="c1">// defining the constructor arguments for the UDF (but not providing an alias name)</span>
<span class="n">FUNCTION</span> <span class="n">com</span><span class="p">.</span><span class="n">linkedin</span><span class="p">.</span><span class="n">dwh</span><span class="p">.</span><span class="n">udf</span><span class="p">.</span><span class="n">filter</span><span class="p">.</span><span class="n">IsTestMemberId</span><span class="p">(</span><span class="s">&quot;input/etl/testMemberId.txt&quot;</span><span class="p">);</span>

<span class="c1">// defining constructor arguments as well as an alias name</span>
<span class="n">FUNCTION</span> <span class="n">isCrawler</span> <span class="n">com</span><span class="p">.</span><span class="n">linkedin</span><span class="p">.</span><span class="n">dwh</span><span class="p">.</span><span class="n">udf</span><span class="p">.</span><span class="n">lookup</span><span class="p">.</span><span class="n">WATBotCrawlerLookup</span><span class="p">(</span><span class="s">&quot;input/etl/bot.properties&quot;</span><span class="p">);</span>

<span class="c1">// defining an alias name for a UDF without constructor arguments</span>
<span class="n">FUNCTION</span> <span class="n">epoch</span> <span class="n">com</span><span class="p">.</span><span class="n">linkedin</span><span class="p">.</span><span class="n">dwh</span><span class="p">.</span><span class="n">udf</span><span class="p">.</span><span class="n">date</span><span class="p">.</span><span class="n">epochToFormat</span><span class="p">();</span>
</pre></div>
</div>
<p>REGISTER command first looks the jar in the local filesystem. If found, it copies the jar to a temporary folder in HDFS and adds it to classpath. Otherwise, it assumes that the jar is present in the HDFS at the specified location.</p>
<p>SET command accepts two parameters: the property name, and the value (as a String). This command assigns these properties to the Hadoop Job configuration.</p>
<p>FUNCTION can be used to define an alias for the UDF (which can be used in the FROM..GENERATE operator). Additionally, it can be used to provide constructor arguments to the UDF. The UDF is fully compatible with Pig API for defining function (via the <em>EvalFunc</em> super-class).</p>
</div>
<div class="section" id="structure-of-a-job">
<h3>Structure of a Job<a class="headerlink" href="#structure-of-a-job" title="Permalink to this headline">¶</a></h3>
<p>There are two kinds of jobs: Map-Reduce jobs and Refresh-Dictionary jobs. In this section we will look at the Map-Reduce jobs only; the Refresh-Dictionary job is discussed later in <em class="xref std std-ref">dictionary-job</em>.</p>
<p>The general pattern of a Map-Reduce job is as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;name of this job&quot;</span>
        <span class="n">REDUCERS</span> <span class="o">&lt;</span><span class="kt">int</span><span class="o">:</span> <span class="n">number</span> <span class="n">of</span> <span class="n">reducers</span><span class="o">&gt;;</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="o">&lt;&lt;</span> <span class="n">load</span> <span class="n">command</span> <span class="o">&gt;&gt;</span>
                <span class="o">&lt;&lt;</span> <span class="n">operators</span> <span class="o">&gt;&gt;</span>
        <span class="o">}</span>
        <span class="o">&lt;&lt;</span> <span class="n">shuffle</span> <span class="n">command</span> <span class="o">&gt;&gt;</span>
        <span class="n">REDUCE</span> <span class="o">{</span>
                <span class="o">&lt;&lt;</span> <span class="n">operators</span> <span class="o">&gt;&gt;</span>
        <span class="o">}</span>
        <span class="o">&lt;&lt;</span> <span class="n">store</span> <span class="n">command</span> <span class="o">&gt;&gt;</span>
<span class="n">END</span>
</pre></div>
</div>
<p>It is also possible to write a Map-only job (without any reducer) as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;name of this job&quot;</span>
        <span class="c1">// we do not need to specify the number of reducers</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="o">&lt;&lt;</span> <span class="n">load</span> <span class="n">command</span> <span class="o">&gt;&gt;</span>
                <span class="o">&lt;&lt;</span> <span class="n">operators</span> <span class="o">&gt;&gt;</span>
        <span class="o">}</span>
        <span class="o">&lt;&lt;</span> <span class="n">store</span> <span class="n">command</span> <span class="o">&gt;&gt;</span>
<span class="n">END</span>
</pre></div>
</div>
<ul class="simple">
<li>Each job must be provided with a name.</li>
<li>REDUCERS: Each job must specify the number of reducers. For map-only jobs, this can be omitted, or explicitly set  to 0.</li>
<li>LOAD: Each MAP code block must start with a load command. See <a class="reference internal" href="operators/load_store.html#load-store"><em>Input/Output Operators</em></a> on specifications of this command.</li>
<li>STORE: Each job must end with a store command. See REF on the specifications of this command.</li>
<li>SHUFFLE: In a Map-Reduce job, there must be a shuffle command (see <a class="reference internal" href="operators/shuffle.html#shuffle-commands"><em>Shuffle Operators</em></a>) as well as REDUCE code block.</li>
</ul>
<p>It is possible to specify multiple mappers in a single job. See <em class="xref std std-ref">multi-mapper</em> for details.</p>
</div>
</div>
<div class="section" id="word-count-in-cubert">
<h2>Word Count in Cubert<a class="headerlink" href="#word-count-in-cubert" title="Permalink to this headline">¶</a></h2>
<p>Let us now walk through the word count script we discussed in previous section (reproduced below).</p>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;word count job&quot;</span>
    <span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
    <span class="n">MAP</span> <span class="o">{</span>
        <span class="c1">// load the input data set as a TEXT file</span>
        <span class="n">input</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$CUBERT_HOME/examples/words.txt&quot;</span> <span class="n">USING</span> <span class="n">TEXT</span><span class="o">(</span><span class="s">&quot;schema&quot;</span><span class="o">:</span> <span class="s">&quot;STRING word&quot;</span><span class="o">);</span>
        <span class="c1">// add a column to each tuple</span>
        <span class="n">with_count</span> <span class="o">=</span> <span class="n">FROM</span> <span class="n">input</span> <span class="n">GENERATE</span> <span class="n">word</span><span class="o">,</span> <span class="mi">1</span> <span class="n">AS</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// shuffle the data and also invoke combiner to aggregate on map-side</span>
    <span class="n">SHUFFLE</span> <span class="n">with_count</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">word</span> <span class="n">AGGREGATES</span> <span class="nf">COUNT</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="n">AS</span> <span class="n">count</span><span class="o">;</span>
    <span class="n">REDUCE</span> <span class="o">{</span>
        <span class="c1">// at the reducers, sum the counts for each word</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">GROUP</span> <span class="n">with_count</span> <span class="n">BY</span> <span class="n">word</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="n">AS</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// store the output using TEXT format</span>
    <span class="n">STORE</span> <span class="n">output</span> <span class="n">INTO</span> <span class="s">&quot;output&quot;</span> <span class="n">USING</span> <span class="n">TEXT</span><span class="o">();</span>
<span class="n">END</span>
</pre></div>
</td></tr></table></div>
<p><strong>Map Phase</strong></p>
<ul class="simple">
<li>The Map phase starts with the load command. In this case, we are loading <em>$CUBERT_HOME/examples/words.txt</em> as a text file. We also specify the schema of the input.</li>
<li>The LOAD command supports loading daily/hourly data by providing time ranges, filenames with #LATEST or *, or multiple files.</li>
<li>In addition to TEXT format, cubert can also load AVRO and CubertStore file formats. For these two formats, it is not required to supply the schema (cubert will automatically fetch schema from the data files).</li>
<li>After the load command, there is one operator that adds a column to the rows.</li>
</ul>
<p><strong>Shuffle Phase</strong></p>
<ul class="simple">
<li>In this example, we use the basic SHUFFLE operator. Cubert supports other shuffle operators as well: BLOCKGEN, CUBE-COUNT-DISTINCT and CUBE-ADDITIVE.</li>
<li>The shuffle operator specifies that the data (from the mappers) must be partitioned on the <em>word</em> column.</li>
<li>The shuffle operator also specifies a <em>Combiner</em> (via the AGGREGATES clause) to sum the count values.</li>
</ul>
<p><strong>Reduce Phase</strong></p>
<ul class="simple">
<li>The input to the operators in this phase is the relation that was shuffled (<em>with_count</em>).</li>
</ul>
<p><strong>Store Command</strong></p>
<ul class="simple">
<li>The output is stored in text format in the specified folder.</li>
<li>Cubert can store data in AVRO and CubertStore format as well.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>About Variable Scope</p>
<p>The variables names within MAP and REDUCE code blocks are <strong>not visible</strong> outside.</p>
<p class="last">There are, however, two exceptions: (1) only the last variable on the LHS in the MAP phase is visible to the SHUFFLE command. This same variable name is also visible to the REDUCE commands, (2) only the last variable on the LHS in the REDUCE phase is visible to the STORE command.</p>
</div>
<p>While the above Cubert Script code above is already very concise representation of the Word Count problem; as a matter of interest, the <em>idiomatic</em> way of writing in Cubert is even more concise (and a lot faster)!</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;idiomatic word count program (even more concise!)&quot;</span>
        <span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="n">input</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;words.txt&quot;</span> <span class="n">USING</span> <span class="n">TEXT</span><span class="o">(</span><span class="s">&quot;schema&quot;</span><span class="o">:</span> <span class="s">&quot;STRING word&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">CUBE</span> <span class="n">input</span> <span class="n">BY</span> <span class="n">word</span> <span class="n">AGGREGATES</span> <span class="nf">COUNT</span><span class="o">(</span><span class="n">word</span><span class="o">)</span> <span class="n">AS</span> <span class="n">count</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="n">STORE</span> <span class="n">input</span> <span class="n">INTO</span> <span class="s">&quot;output&quot;</span> <span class="n">USING</span> <span class="n">TEXT</span><span class="o">();</span>
<span class="n">END</span>
</pre></div>
</div>
<p>How this actually works? Lets study the <a class="reference internal" href="concepts/index.html#cubert-concepts"><em>cubert core concepts</em></a> first!</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="concepts/index.html" class="btn btn-neutral float-right" title="Understanding Cubert Concepts"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="wordcount.html" class="btn btn-neutral" title="Our First Cubert Program"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, LinkedIn Cubert Team.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>