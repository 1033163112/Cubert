

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Shuffle Operators &mdash; Cubert 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Cubert 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="Cubert Operators" href="index.html"/>
        <link rel="next" title="Extending Cubert" href="../userdefined/index.html"/>
        <link rel="prev" title="Block Operators" href="blocks.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Cubert</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install.html#upgrading-cubert">Upgrading Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../wordcount.html">Our First Cubert Program</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#the-cubert-map-reduce-cmr-script">The Cubert Map-Reduce (.cmr) Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#parsing-and-compiling-the-script">Parsing and Compiling the Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#running-the-script">Running the Script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cmr_language_reference.html">Cubert Map-Reduce Language Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#structure-of-a-cubert-program">Structure of a Cubert Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#word-count-in-cubert">Word Count in Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">Understanding Cubert Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/blocks.html">Partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/coblocks.html">Co-partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/rubixtool.html">Analyzing Rubix File with <em>rubixtool</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/grouping_sets.html">Aggregation: Cube and Grouping Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/conditions.html">Operator Preconditions</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cubert Operators</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="load_store.html">Input/Output Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="processing.html">Processing Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="builtin_functions.html">Builtin Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="join.html">Join Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="aggregation.html">Aggregation Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="dictionary.html">Dictionary Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocks.html">Block Operators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Shuffle Operators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../userdefined/index.html">Extending Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/functions.html">User Defined Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/aggregations.html">User Defined Aggregation Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/operators.html">Adding new Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/storage.html">Adding new Storage Formats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../patterns/index.html">Typical Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../patterns/union.html">UNION Pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../javadoc.html">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications and Presentations</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Cubert</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Cubert Operators</a> &raquo;</li>
      
    <li>Shuffle Operators</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="shuffle-operators">
<span id="shuffle-commands"></span><h1>Shuffle Operators<a class="headerlink" href="#shuffle-operators" title="Permalink to this headline">¶</a></h1>
<div class="section" id="shuffle">
<h2>SHUFFLE<a class="headerlink" href="#shuffle" title="Permalink to this headline">¶</a></h2>
<p>The SHUFFLE operator appears between the map and reduce phases and requires the partition keys and the sort keys to shuffle the input data. In case the sort keys are not specified, it defaults to the partition keys. Optionally, the SHUFFLE operator can take aggregation functions to be applied as a part of the combiner and the corresponding output column names and types.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="c1">// SHUFFLE the data on the given partition and sort keys</span>
<span class="n">SHUFFLE</span> <span class="n">mapoutput</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">memberId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">memberId</span><span class="o">;</span>

    <span class="c1">// SHUFFLE the data after applying the aggregations in the combiner</span>
<span class="n">SHUFFLE</span> <span class="n">datablock</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">sum</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">sum:</span><span class="n">Long</span><span class="o">;</span>
</pre></div>
</div>
<p>PRECONDITIONS: None.</p>
</div>
<div class="section" id="blockgen">
<span id="id1"></span><h2>BLOCKGEN<a class="headerlink" href="#blockgen" title="Permalink to this headline">¶</a></h2>
<p>Please check out the <a class="reference internal" href="../concepts/blocks.html#partitioned-blocks"><em>Partitioned Blocks</em></a> and <a class="reference internal" href="../concepts/coblocks.html#copartitioned-blocks"><em>Co-partitioned Blocks</em></a> sections first for an understanding of the Cubert Block concepts.</p>
<p>BLOCKGEN shuffle operator creates blocks from the output of the mappers. The blocks are created based on either:</p>
<ul class="simple">
<li>the number of rows</li>
<li>the size of the block</li>
<li>the index of another BLOCKGEN dataset</li>
</ul>
<p>In addition, the BLOCKGEN operator takes the partition key and optionally the sort keys for creating the blocks. The sort keys default to partition keys if not specified. Optionally, this operator can do a DISTINCT on the data after shuffle, but before creating blocks.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="c1">// creates blocks each with at most 10000 rows</span>
<span class="n">BLOCKGEN</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">ROW</span> <span class="mi">10000</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">member_sk</span><span class="o">,</span> <span class="n">country_sk</span><span class="o">;</span>

    <span class="c1">// creates blocks each with at most 10MB in size</span>
<span class="n">BLOCKGEN</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">SIZE</span> <span class="mi">10000000</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">member_sk</span><span class="o">;</span>

    <span class="c1">// creates blocks that have the same index as that of the input index</span>
<span class="n">BLOCKGEN</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">INDEX</span> <span class="s">&quot;output/memberBlockgen&quot;</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">memberId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">memberId</span><span class="o">,</span> <span class="n">search_type</span><span class="o">;</span>

<span class="c1">// creates block after doing a distinct on the input data of the reducer, but before creating the blocks</span>
    <span class="n">BLOCKGEN</span> <span class="n">DISTINCT</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">ROW</span> <span class="mi">25000</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">ContextId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">ContextId</span><span class="o">;</span>
</pre></div>
</div>
<p>PRECONDITIONS: None.</p>
</div>
<div class="section" id="cube">
<span id="cube-shuffle"></span><h2>CUBE<a class="headerlink" href="#cube" title="Permalink to this headline">¶</a></h2>
<p>CUBE is also a shuffle operator that performs the cube computation on additive and partitioned-additive. The advantage of this operator over the <a class="reference internal" href="aggregation.html#cube-operator"><em>CUBE operator</em></a> is that it abstracts the multiple operators needed for computation. Specifically, this single operator is equivalent to CUBE on the mapper, followed by a shuffle and combiner, and a group by and aggregate on the reducer. The following examples demonstrate the simplicity of this operator.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">MAP</span> <span class="o">{</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$inputFactTable&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">CUBE</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">COUNT</span><span class="o">(</span><span class="n">memberId</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">sum:</span><span class="kt">long</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="o">(</span><span class="n">dim0</span><span class="o">),</span> <span class="o">(</span><span class="n">dim1</span><span class="o">);</span>
<span class="c1">// compute full cube as: CUBE a BY dim0, dim1 AGGREGATES COUNT(memberId) AS sum:long;</span>
<span class="n">STORE</span> <span class="n">a</span> <span class="n">INTO</span> <span class="s">&quot;$output&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
</pre></div>
</div>
<p>If needed, other operators can be run on the output of CUBE on the reducer:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">MAP</span> <span class="o">{</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$inputFactTable&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">CUBE</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">COUNT</span><span class="o">(</span><span class="n">memberId</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">sum:</span><span class="kt">long</span> <span class="n">GROUPING</span> <span class="n">SETS</span> <span class="o">(</span><span class="n">dim0</span><span class="o">),</span> <span class="o">(</span><span class="n">dim1</span><span class="o">);</span>
<span class="n">REDUCER</span> <span class="o">{</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">FILTER</span> <span class="n">a</span> <span class="n">BY</span> <span class="n">dim0</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">STORE</span> <span class="n">output</span> <span class="n">INTO</span> <span class="s">&quot;$output&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
</pre></div>
</div>
<p>This operator can also compute count distinct by specifying the measure as the partitioning key.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">MAP</span> <span class="o">{</span>
   <span class="n">cube</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$inputFactTable&quot;</span> <span class="n">USING</span> <span class="n">CubertStore</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// computes full OLAP cube</span>
<span class="n">CUBE</span> <span class="n">cube</span> <span class="n">BY</span> <span class="n">PageKey</span><span class="o">,</span> <span class="n">ProductPageKeyGroup</span><span class="o">,</span> <span class="n">Locale</span><span class="o">,</span> <span class="n">Platform</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">ContextId</span>
                                    <span class="n">COUNT_DISTINCT</span><span class="o">(</span><span class="n">ContextId</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">contextCount:</span><span class="n">LONG</span><span class="o">;</span>
<span class="n">STORE</span> <span class="n">output</span> <span class="n">INTO</span> <span class="s">&quot;output&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
</pre></div>
</div>
<p>PRECONDITIONS: None.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../userdefined/index.html" class="btn btn-neutral float-right" title="Extending Cubert"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="blocks.html" class="btn btn-neutral" title="Block Operators"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, LinkedIn Cubert Team.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>