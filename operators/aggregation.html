

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Aggregation Operators &mdash; Cubert 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Cubert 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="Cubert Operators" href="index.html"/>
        <link rel="next" title="Dictionary Operators" href="dictionary.html"/>
        <link rel="prev" title="Join Operators" href="join.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Cubert</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install.html#upgrading-cubert">Upgrading Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../wordcount.html">Our First Cubert Program</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#the-cubert-map-reduce-cmr-script">The Cubert Map-Reduce (.cmr) Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#parsing-and-compiling-the-script">Parsing and Compiling the Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#running-the-script">Running the Script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cmr_language_reference.html">Cubert Map-Reduce Language Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#structure-of-a-cubert-program">Structure of a Cubert Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#word-count-in-cubert">Word Count in Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">Understanding Cubert Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/blocks.html">Partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/coblocks.html">Co-partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/rubixtool.html">Analyzing Rubix File with <em>rubixtool</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/grouping_sets.html">Aggregation: Cube and Grouping Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/conditions.html">Operator Preconditions</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Cubert Operators</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="load_store.html">Input/Output Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="processing.html">Processing Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="builtin_functions.html">Builtin Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="join.html">Join Operators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Aggregation Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="dictionary.html">Dictionary Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocks.html">Block Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="shuffle.html">Shuffle Operators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../userdefined/index.html">Extending Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/functions.html">User Defined Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/aggregations.html">User Defined Aggregation Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/operators.html">Adding new Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/storage.html">Adding new Storage Formats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../patterns/index.html">Typical Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../patterns/union.html">UNION Pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../javadoc.html">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications and Presentations</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Cubert</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Cubert Operators</a> &raquo;</li>
      
    <li>Aggregation Operators</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="aggregation-operators">
<h1>Aggregation Operators<a class="headerlink" href="#aggregation-operators" title="Permalink to this headline">¶</a></h1>
<div class="section" id="group-by">
<h2>GROUP BY<a class="headerlink" href="#group-by" title="Permalink to this headline">¶</a></h2>
<p>This operator computes group by aggregates on the input relation. Group by lets us specify the dimensions (or columns) on which the group bys are computed, the aggregation functions, the corresponding input columns, and optionally the names of the output columns of the computed aggregates. Group by operator supports SUM, COUNT, MIN, MAX, COUNT_DISTINCT and UDAFs (user defined aggregation functions).</p>
<p>The output tuples from this operator will contain all the group by columns and also the output columns from the aggregation functions.</p>
<p>Sample usages of GROUP BY operator.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// compute group by on two group by keys, compute sum aggregate on uniqueDaily and return the sum in a column named uniqueDailySum of type long</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">GROUP</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">default_locale_sk</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">uniqueDaily</span><span class="o">)</span> <span class="n">AS</span> <span class="n">uniqueDailySum</span><span class="o">;</span>

<span class="c1">// compute multiple aggregates</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">GROUP</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">storeId</span> <span class="n">AGGREGATES</span> <span class="n">COUNT</span><span class="o">(</span><span class="n">tranId</span><span class="o">)</span> <span class="n">AS</span> <span class="n">tranCount</span><span class="o">,</span> <span class="n">SUM</span><span class="o">(</span><span class="n">sales</span><span class="o">)</span> <span class="n">AS</span> <span class="n">totalSales</span><span class="o">;</span>
</pre></div>
</div>
<p>PRECONDITIONS: The input relation must be <em>partitioned</em> and <em>sorted</em> on the group by columns. For COUNT_DISTINCT aggregations, the input relation must be <em>partitioned</em> and <em>sorted</em> on concatenation of group by columns and the count distinct column.</p>
</div>
<div class="section" id="cube">
<span id="cube-operator"></span><h2>CUBE<a class="headerlink" href="#cube" title="Permalink to this headline">¶</a></h2>
<p>This operator computes multiple group by over the input dataset. See <a class="reference internal" href="../concepts/grouping_sets.html#grouping-sets"><em>Aggregation: Cube and Grouping Sets</em></a> on a discussion of the OLAP Cube and grouping sets.</p>
<p>The operator can compute two kinds of aggregates: Additive and Partitioned-Additive (see <a class="reference internal" href="../concepts/grouping_sets.html#grouping-sets"><em>Aggregation: Cube and Grouping Sets</em></a>).</p>
<div class="section" id="additive-aggregates">
<h3>Additive Aggregates<a class="headerlink" href="#additive-aggregates" title="Permalink to this headline">¶</a></h3>
<p>Cubert supports following builtin aggregators: SUM, COUNT, MIN, MAX.</p>
<p>Example usage: computing a complete OLAP cube on two dimensions.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;cube additive computing a full OLAP cube.&quot;</span>
<span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
<span class="n">MAP</span> <span class="o">{</span>
        <span class="c1">// load the fact table</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$inputFactTable&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
                    <span class="c1">// compute &quot;full&quot; cube</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">CUBE</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">measure</span><span class="o">)</span> <span class="n">AS</span> <span class="n">sum</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">SHUFFLE</span> <span class="n">data</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">measure</span><span class="o">)</span> <span class="n">AS</span> <span class="n">sum</span><span class="o">;</span>
<span class="n">REDUCE</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">GROUP</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">dim0</span><span class="o">,</span> <span class="n">dim1</span> <span class="n">AGGREGATES</span> <span class="n">SUM</span><span class="o">(</span><span class="n">sum</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">sum:</span><span class="kt">long</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">STORE</span> <span class="n">result</span> <span class="n">INTO</span> <span class="s">&quot;output/cube&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
<span class="n">END</span>
</pre></div>
</div>
<p>PRECONDITIONS: None.</p>
</div>
<div class="section" id="partitioned-additive-aggregators">
<h3>Partitioned Additive Aggregators<a class="headerlink" href="#partitioned-additive-aggregators" title="Permalink to this headline">¶</a></h3>
<p>CUBE operator can also compute OLAP cube count distinct on the input relation. In its specification, it  takes the list of dimensions, the partitioning measure to compute count distinct on and the corresponding output column names.</p>
<p>Optionally the grouping sets can be specified, listing the group by key combinations to be computed. If no grouping sets is specified, the full OLAP cube is computed.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;OLAP cube count distinct operator&quot;</span>
<span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
<span class="n">MAP</span> <span class="o">{</span>
    <span class="c1">// load the fact table</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;$inputFactTable&quot;</span> <span class="n">USING</span> <span class="n">RUBIX</span><span class="o">;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">FROM</span> <span class="n">data</span> <span class="n">GENERATE</span> <span class="n">memberId</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span><span class="o">,</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span>
                              <span class="n">CASE</span> <span class="o">(</span><span class="n">date_sk</span> <span class="o">==</span> <span class="s">&quot;2014-02-06&quot;</span><span class="o">,</span> <span class="n">memberId</span><span class="o">)</span> <span class="n">AS</span> <span class="n">todayMemberId</span><span class="o">;</span>

    <span class="c1">// OLAP CCD computation on a grouping set</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">CUBE</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span> <span class="n">INNER</span> <span class="n">memberId</span>
                    <span class="n">AGGREGATES</span> <span class="nf">COUNT_DISTINCT</span><span class="o">(</span><span class="n">memberId</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">uniqueWeekly:</span><span class="n">LONG</span><span class="o">,</span> <span class="o">[</span><span class="n">SUM</span><span class="o">,</span> <span class="n">COUNT_TO_ONE</span><span class="o">](</span><span class="n">todayMemberId</span><span class="o">)</span> <span class="n">AS</span> <span class="n">uniqueDaily</span>
                    <span class="n">GROUPING</span> <span class="nf">SETS</span> <span class="o">(</span><span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span><span class="o">),</span>
                                  <span class="o">(</span><span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">),</span>
                                  <span class="o">(</span><span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">platform_type</span><span class="o">),</span>
                                  <span class="o">(</span><span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">SHUFFLE</span> <span class="n">cube</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span>
                <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span><span class="o">;</span>
<span class="n">REDUCE</span> <span class="o">{</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">GROUP</span> <span class="n">cube</span> <span class="n">BY</span> <span class="n">country_sk</span><span class="o">,</span> <span class="n">locale_sk</span><span class="o">,</span> <span class="n">search_type</span><span class="o">,</span> <span class="n">platform_type</span>
                    <span class="n">AGGREGATES</span> <span class="nf">SUM</span><span class="o">(</span><span class="n">uniqueWeekly</span><span class="o">)</span> <span class="n">AS</span> <span class="nl">uniqueWeekly:</span><span class="kt">long</span><span class="o">,</span> <span class="n">SUM</span><span class="o">(</span><span class="n">uniqueDaily</span><span class="o">)</span> <span class="n">AS</span> <span class="n">uniqueDaily</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">STORE</span> <span class="n">output</span> <span class="n">INTO</span> <span class="s">&quot;$output/ccdOutput&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">;</span>
<span class="n">END</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Using CUBE Shuffle Command</p>
<p class="last">See the section on using the <a class="reference internal" href="shuffle.html#cube-shuffle"><em>CUBE shuffle command</em></a> that describes a much compact (and less error prone) form for this operator.</p>
</div>
<p>PRECONDITIONS: The input data must be <em>partitioned</em> and <em>sorted</em> on the measure (<em>memberId</em> in the above example).</p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dictionary.html" class="btn btn-neutral float-right" title="Dictionary Operators"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="join.html" class="btn btn-neutral" title="Join Operators"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, LinkedIn Cubert Team.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>