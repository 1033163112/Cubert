

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Co-partitioned Blocks &mdash; Cubert 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Cubert 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="Understanding Cubert Concepts" href="index.html"/>
        <link rel="next" title="Analyzing Rubix File with rubixtool" href="rubixtool.html"/>
        <link rel="prev" title="Partitioned Blocks" href="blocks.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Cubert</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install.html#upgrading-cubert">Upgrading Cubert</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../wordcount.html">Our First Cubert Program</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#the-cubert-map-reduce-cmr-script">The Cubert Map-Reduce (.cmr) Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#parsing-and-compiling-the-script">Parsing and Compiling the Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wordcount.html#running-the-script">Running the Script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cmr_language_reference.html">Cubert Map-Reduce Language Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#structure-of-a-cubert-program">Structure of a Cubert Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmr_language_reference.html#word-count-in-cubert">Word Count in Cubert</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Understanding Cubert Concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="blocks.html">Partitioned Blocks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Co-partitioned Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="rubixtool.html">Analyzing Rubix File with <em>rubixtool</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="grouping_sets.html">Aggregation: Cube and Grouping Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="conditions.html">Operator Preconditions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../operators/index.html">Cubert Operators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../operators/load_store.html">Input/Output Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/processing.html">Processing Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/builtin_functions.html">Builtin Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/join.html">Join Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/aggregation.html">Aggregation Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/dictionary.html">Dictionary Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/blocks.html">Block Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operators/shuffle.html">Shuffle Operators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../userdefined/index.html">Extending Cubert</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/functions.html">User Defined Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/aggregations.html">User Defined Aggregation Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/operators.html">Adding new Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../userdefined/storage.html">Adding new Storage Formats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../patterns/index.html">Typical Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../patterns/union.html">UNION Pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../javadoc.html">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications and Presentations</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Cubert</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Understanding Cubert Concepts</a> &raquo;</li>
      
    <li>Co-partitioned Blocks</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="co-partitioned-blocks">
<span id="copartitioned-blocks"></span><h1>Co-partitioned Blocks<a class="headerlink" href="#co-partitioned-blocks" title="Permalink to this headline">¶</a></h1>
<p>Let us now look at the second mechanism for creating blocks. Here, we would like to create blocks that are partitioned along the index of <em>some other relation</em>. Say, we have a dataset <strong>P</strong> which we reorganized into blocks using the BLOCKGEN process as described in <a class="reference internal" href="blocks.html#partitioned-blocks"><em>Partitioned Blocks</em></a>. Internally, the BLOCKGEN process would divide the overall range of partition keys into sub-ranges, where each sub-range correspond to one block. As an example, suppose we created blocks partitioned on memberId, then we would have index something like:</p>
<blockquote>
<div><div class="line-block">
<div class="line">memberIds from 0 to 1000 =&gt; block 0</div>
<div class="line">memberIds from 1001 to 1500 =&gt; block 1</div>
<div class="line">and so on until block N</div>
</div>
</div></blockquote>
<p>Now, assume that we have a second dataset <strong>S</strong>. We would like to create <em>N</em> blocks (same as the number of blocks in <strong>P</strong>), that are consistently partitioned along the <strong>P</strong> dataset. What we mean here is that the block <em>i</em> of <strong>S</strong> will have the same memberIds as were in the block <em>i</em> in <strong>P</strong>. In other words, if memberId = 1234 were to be found in block 2 of <strong>P</strong>, then we are ensured to find this memberId in block 2 of <strong>S</strong>. This pattern of consistent partitioning is needed for Map-side joins to these two datasets.</p>
<p>The process of creating consistent partitioned blocks (on some other primary relation) is called <strong>BLOCKGEN BY INDEX</strong>.</p>
<div class="section" id="blockgen-by-index-checklist">
<h2>BLOCKGEN BY INDEX Checklist<a class="headerlink" href="#blockgen-by-index-checklist" title="Permalink to this headline">¶</a></h2>
<p>As Cubert users, we are responsible for following three actions:</p>
<ol class="arabic">
<li><p class="first">Defining the primary relation: to specify the index along which we would like to partition our dataset.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">BLOCKGEN BY INDEX is a transitive operation. As an example, say we have three datasets: A, B, C. We created blocks out of A using the BLOCKGEN process, and we created co-partitioned blocks of B using A as the primary relation. Now considering C, we can create co-partitioned blocks using either A or B as the primary relation (both are equivalent).</p>
</div>
</div></blockquote>
</li>
<li><p class="first">(Optional) Defining Sorting Keys: the columns along with <em>each block</em> is sorted.</p>
<blockquote>
<div><p>As before, the sorting happens <em>within the blocks</em>. That is, the data is NOT globally sorted.</p>
</div></blockquote>
</li>
<li><p class="first">Storing the BLOCKGEN BY INDEX data in RUBIX file format: the dataset organized into blocks MUST be stored in RUBIX file format.</p>
<blockquote>
<div><p>RUBIX supports a custom data layout format that embeds indices and other metadata related to the BLOCKGEN BY INDEX process.</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="creating-co-partitioned-blocks">
<h2>Creating Co-Partitioned Blocks<a class="headerlink" href="#creating-co-partitioned-blocks" title="Permalink to this headline">¶</a></h2>
<p>The blocks are created using the BLOCKGEN shuffle command, by using the &#8220;BY INDEX&#8221; form the the command. As can example,</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// the primary dataset</span>
<span class="n">JOB</span> <span class="s">&quot;our first BLOCKGEN&quot;</span>
        <span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;/path/to/data&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">BLOCKGEN</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">ROW</span> <span class="mi">1000</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">memberId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">timestamp</span><span class="o">;</span>
        <span class="n">STORE</span> <span class="n">data</span> <span class="n">INTO</span> <span class="s">&quot;/path/to/output&quot;</span> <span class="n">USING</span> <span class="n">RUBIX</span><span class="o">();</span>
<span class="n">END</span>

<span class="n">JOB</span> <span class="s">&quot;our first blockgen by index&quot;</span>
        <span class="n">REDUCERS</span> <span class="mi">20</span><span class="o">;</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;/path/to/other/data&quot;</span> <span class="n">USING</span> <span class="n">AVRO</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">BLOCKGEN</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">INDEX</span> <span class="s">&quot;/path/to/output&quot;</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">memberId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">some_column</span><span class="o">;</span>
        <span class="n">STORE</span> <span class="n">data</span> <span class="n">INTO</span> <span class="s">&quot;/path/to/other/output&quot;</span> <span class="n">USING</span> <span class="n">RUBIX</span><span class="o">();</span>
<span class="n">END</span>
</pre></div>
</div>
<p>Notice the <strong>BY INDEX &#8220;/path/to/output&#8221;</strong> script fragment. We have specified here that we would like to create co-partitioned blocks using &#8220;/path/to/output&#8221; (created in the first job) as the primary dataset.</p>
</div>
<div class="section" id="idiom-of-resorting-blocks">
<h2>Idiom of Resorting Blocks<a class="headerlink" href="#idiom-of-resorting-blocks" title="Permalink to this headline">¶</a></h2>
<p>The BLOCKGEN BY INDEX process has another use case &#8211; to resort already created blocks!</p>
<p>In the example above, we had the first dataset sorted on <em>timestamp</em>. Lets say we want to resort each block on some other columns (say, pagekey). We can use the same BLOCKGEN BY INDEX command to resort data, while making sure that rows within each block remains intact.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">JOB</span> <span class="s">&quot;resorting blocks&quot;</span>
        <span class="n">REDUCERS</span> <span class="mi">10</span><span class="o">;</span>
        <span class="n">MAP</span> <span class="o">{</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">LOAD</span> <span class="s">&quot;/path/to/output&quot;</span> <span class="n">USING</span> <span class="n">RUBIX</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">BLOCKGEN</span> <span class="n">data</span> <span class="n">BY</span> <span class="n">INDEX</span> <span class="s">&quot;/path/to/output&quot;</span> <span class="n">PARTITIONED</span> <span class="n">ON</span> <span class="n">memberId</span> <span class="n">SORTED</span> <span class="n">ON</span> <span class="n">pagekey</span><span class="o">;</span>
        <span class="n">STORE</span> <span class="n">data</span> <span class="n">INTO</span> <span class="s">&quot;/path/to/resorted-output&quot;</span> <span class="n">USING</span> <span class="n">RUBIX</span><span class="o">();</span>
<span class="n">END</span>
</pre></div>
</div>
<p>We just have to make sure that, (a) we use the primary dataset we use was created via BLOCKGEN process (see note above), and (b) the partition keys must be identical.</p>
<p>Of course, we can also sort the second dataset as well, the one that was created using the BLOCKGEN BY INDEX command.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rubixtool.html" class="btn btn-neutral float-right" title="Analyzing Rubix File with rubixtool"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="blocks.html" class="btn btn-neutral" title="Partitioned Blocks"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, LinkedIn Cubert Team.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>